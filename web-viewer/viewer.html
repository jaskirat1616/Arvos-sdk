<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARVOS Autopilot Viewer</title>
    <link rel="stylesheet" href="css/tesla-style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="autopilot-container">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="logo">ARVOS</div>
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">DISCONNECTED</span>
            </div>
            <div class="stats-compact">
                <div class="stat"><span class="label">FPS</span><span class="value" id="fps">0</span></div>
                <div class="stat"><span class="label">LATENCY</span><span class="value" id="latency">0ms</span></div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="main-grid">
            <!-- Left Panel: 3D Point Cloud Visualization -->
            <div class="panel primary-view">
                <div class="panel-header">
                    <span class="panel-title">3D ENVIRONMENT</span>
                    <div class="view-controls">
                        <button class="view-btn" onclick="setView('perspective')" id="btn-perspective">3D</button>
                        <button class="view-btn" onclick="setView('top')" id="btn-top">TOP</button>
                        <button class="view-btn" onclick="setView('side')" id="btn-side">SIDE</button>
                    </div>
                </div>
                <div id="canvas-3d" class="canvas-container"></div>
                <div class="overlay-info">
                    <div class="info-box">
                        <span class="info-label">POINTS</span>
                        <span class="info-value" id="pointCount">0</span>
                    </div>
                    <div class="info-box">
                        <span class="info-label">RANGE</span>
                        <span class="info-value" id="depthRange">0m</span>
                    </div>
                </div>
            </div>

            <!-- Center Panel: Camera Feed -->
            <div class="panel camera-view">
                <div class="panel-header">
                    <span class="panel-title">CAMERA</span>
                    <div class="camera-info">
                        <span id="cameraRes">-</span>
                    </div>
                </div>
                <div class="camera-container">
                    <canvas id="cameraCanvas"></canvas>
                    <div class="camera-overlay">
                        <div class="crosshair"></div>
                    </div>
                </div>
            </div>

            <!-- Right Top: Map View -->
            <div class="panel map-view">
                <div class="panel-header">
                    <span class="panel-title">GPS TRACKING</span>
                    <div class="map-controls">
                        <button class="map-btn" onclick="centerMap()" title="Center on device">⊕</button>
                    </div>
                </div>
                <div id="map" class="map-container"></div>
                <div class="map-overlay">
                    <div class="map-stat">
                        <span class="label">LAT</span>
                        <span id="gpsLat">-</span>
                    </div>
                    <div class="map-stat">
                        <span class="label">LON</span>
                        <span id="gpsLon">-</span>
                    </div>
                    <div class="map-stat">
                        <span class="label">SPD</span>
                        <span id="gpsSpeed">0 km/h</span>
                    </div>
                </div>
            </div>

            <!-- Right Bottom: IMU & Sensors -->
            <div class="panel sensor-panel">
                <div class="panel-header">
                    <span class="panel-title">SENSOR TELEMETRY</span>
                </div>
                <div class="sensor-grid">
                    <!-- IMU Visualization -->
                    <div class="sensor-module">
                        <div class="sensor-label">IMU</div>
                        <canvas id="imuCanvas" width="200" height="120"></canvas>
                        <div class="sensor-values">
                            <div><span>ACCEL</span><span id="accel">0.00g</span></div>
                            <div><span>GYRO</span><span id="gyro">0.00°/s</span></div>
                        </div>
                    </div>

                    <!-- Pose Visualization -->
                    <div class="sensor-module">
                        <div class="sensor-label">POSE</div>
                        <canvas id="poseCanvas" width="200" height="120"></canvas>
                        <div class="sensor-values">
                            <div><span>X</span><span id="poseX">0.00m</span></div>
                            <div><span>Y</span><span id="poseY">0.00m</span></div>
                            <div><span>Z</span><span id="poseZ">0.00m</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Control Bar -->
        <div class="bottom-bar">
            <div class="control-section">
                <button class="control-btn" onclick="toggleRecording()" id="recordBtn">
                    <svg width="16" height="16" viewBox="0 0 16 16">
                        <circle cx="8" cy="8" r="6" fill="currentColor"/>
                    </svg>
                    <span>RECORD</span>
                </button>
                <button class="control-btn" onclick="captureSnapshot()">
                    <svg width="16" height="16" viewBox="0 0 16 16">
                        <rect x="2" y="4" width="12" height="8" rx="1" stroke="currentColor" fill="none"/>
                        <circle cx="8" cy="8" r="2" fill="currentColor"/>
                    </svg>
                    <span>SNAPSHOT</span>
                </button>
                <button class="control-btn" onclick="downloadData()">
                    <svg width="16" height="16" viewBox="0 0 16 16">
                        <path d="M8 2v8m0 0l3-3m-3 3L5 7m7 7H4" stroke="currentColor" fill="none"/>
                    </svg>
                    <span>EXPORT</span>
                </button>
            </div>
            <div class="mode-indicator">
                <span id="modeText">AUTOPILOT ACTIVE</span>
            </div>
            <div class="control-section">
                <button class="control-btn" onclick="toggleFullscreen()">
                    <svg width="16" height="16" viewBox="0 0 16 16">
                        <path d="M2 5V2h3M14 5V2h-3M2 11v3h3M14 11v3h-3" stroke="currentColor" fill="none"/>
                    </svg>
                    <span>FULLSCREEN</span>
                </button>
            </div>
        </div>
    </div>

    <script src="js/websocket-client.js"></script>
    <script src="js/tesla-viewer.js"></script>
    <script>
        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const port = urlParams.get('port') || '8765';

            initTeslaViewer(port);
        });
    </script>
</body>
</html>
